# RimSpace
RimSpace是从游戏RimWorld中提取了重要游戏底层逻辑后，简化的游戏环境。该游戏中的NPC将通过MA系统进行驱动。

## 对MA系统的功能要求
MA系统需要满足以下核心功能需求，以实现RimSpace中NPC的智能决策和协作：

1. **角色认知**：Agent需要对自身角色拥有的技能有认知，只能进行拥有对应技能的行为。
2. **配方认知**：Agent需要对生产一个物品的步骤有正确的认知，理解原材料、制作地点和制作流程。
3. **状态认知**：Agent需要感知当前的游戏状态，包括物品位置、其他Agent位置、自身库存、生理和心理状态。
4. **任务协作**：系统需要支持多个Agent通过搬运、生产链等协作完成复杂的生产任务。
5. **决策能力**：Agent需要根据当前状态和任务优先级进行智能决策，权衡生存需求与职责完成。

## 主要角色
其中主要有三个Agent：Farmer、Chef和Crafter。

### Farmer
游戏中的农夫，也是RimSpace的原材料来源。
- **种植作物**：通过在CultivateChamber中进行种植，使对应CultivateChamber中生长玩家指定的作物（棉花或玉米）。
- **收获作物**：通过在CultivateChamber中进行收获，获取CultivateChamber中已经成熟的作物。
- **拥有技能**：CanFarm

### Chef
游戏中的厨师，能够在Stove（炉灶）处进行烹饪工作。
- **烹饪食物**：使用原材料在炉灶处制作食物（用玉米制作套餐）。
- **所需技能**：CanCook

### Crafter
游戏中的工匠，能够在WorkStation（工作站）处进行手工制作。
- **制作物品**：使用原材料和加工品在工作站制作各类物品（例如用棉花制作棉线和布料，用布料和棉线制作衣服）。
- **所需技能**：CanCraft

## 主要物品

### 原材料
#### 棉花 Cotton (ID:1001)
- **来源**：由Farmer在CultivateChamber种植和收获获得
- **用途**：可用于制作棉线或布料

#### 玉米 Corn (ID:1002)
- **来源**：由Farmer在CultivateChamber种植和收获获得
- **用途**：可用于制作套餐

### 加工品
#### 棉线 Thread (ID:2001)
- **来源**：由Crafter在WorkStation用棉花制作而成
- **用途**：与布料一起制作衣服

#### 布料 Cloth (ID:2002)
- **来源**：由Crafter在WorkStation用棉花制作而成
- **用途**：与棉线一起制作衣服

#### 套餐 Meal (ID:2003)
- **来源**：由Chef在Stove用玉米烹饪而成
- **用途**：提供营养支撑，可被角色进食
- **营养值**：80.0
- **进食时间**：20
- **标签**：食物

### 最终品
#### 衣服 Coat (ID:3001)
- **来源**：由Crafter在WorkStation用布料和棉线制作而成
- **用途**：最终产品
- **空间占用**：10格

## 可交互地点

### CultivateChamber（培养舱）
- **功能**：用于种植和收获作物的农业设施
- **使用者**：Farmer
- **相关操作**：
  - 种植（Plant）：将培养舱状态从WaitingToPlant改为Growing，开始生长指定作物
  - 收获（Harvest）：采集成熟作物，每次收获产出作物，培养舱重置为WaitingToPlant状态
- **作物周期**：WaitingToPlant（待种植）→ Growing（生长中）→ ReadyToHarvest（准备收获）

### WorkStation（工作站）
- **功能**：用于手工制作物品的工作台
- **使用者**：Crafter
- **相关操作**：
  - 制作（Craft）：消耗相应原材料，执行指定设计图（TaskID）制作物品
  - 可制作物品：棉线、布料、衣服等
- **特点**：需要足够的原材料库存才能执行制作任务

### Stove（炉灶）
- **功能**：用于烹饪食物的烹饪设备
- **使用者**：Chef
- **相关操作**：
  - 烹饪（Cook）：消耗原材料（如玉米），执行菜谱制作食物
  - 可制作食物：套餐等
- **特点**：需要足够的原材料库存才能执行烹饪任务

### Storage（仓库）
- **功能**：用于存储物品的容器
- **使用者**：所有Agent（Farmer、Chef、Crafter）
- **相关操作**：
  - 取物（Take）：从仓库内取出物品放入背包
  - 放物（Put）：将背包中的物品放入仓库
- **特点**：是中转和存储物品的重要场所，用于协调各Agent之间的物品流通

### Table（餐桌）
- **功能**：用于角色进食补充饱食度
- **使用者**：所有Agent（Farmer、Chef、Crafter）
- **相关操作**：
  - 进食（Eat）：消耗1个套餐（Meal，ID:2003），恢复饱食度
- **特点**：所有角色都需要定期进食来维持体力，食物来自Chef的烹饪

### Bed（床）
- **功能**：用于角色睡眠恢复能量
- **使用者**：所有Agent（Farmer、Chef、Crafter）
- **相关操作**：
  - 睡眠（Sleep）：恢复体力到满。
- **特点**：所有角色都需要睡眠来维持工作能力

## 目前采用的MA系统架构
MA系统实现采用分层决策和任务协调的方式，将高层意图决策与底层执行技能相分离。

### Agent之间的协作机制（黑板系统）
在Agent之间，通过**黑板（Blackboard）**的方式共享任务，实现多Agent的协作：

- **任务发布与共享**：系统根据全局目标和资源需求自动发布任务到黑板，所有Agent都可以看到黑板上的任务。
- **任务过滤与认知**：每个Agent只能感知到自己可以执行的任务（即符合自身技能要求的任务）。这种机制有助于：
  - 保持Agent对自身角色的清晰认知，避免幻觉（例如Chef无法看到需要"生产衣服"的任务，从而不会产生自己能生产衣服的幻觉）
  - 让Agent专注于自身职责范围内的工作
- **前置条件与依赖**：对于需要特定前置条件的任务（如"需要先在仓库有足够的棉花才能生产布料"），系统会明确提供这些条件信息给LLM，便于其做出正确的决策。
- **并发执行**：多个Agent可以并发处理不同的任务，形成高效的生产流水线。

### 单个Agent的决策架构（D2A框架）
单个Agent采用**Decision to Action（D2A）** 的分层决策思想：

**第一层：高层决策（由LLM完成）**
- LLM根据当前游戏状态、自身的生理心理状态（Hunger、Exhaustion、Sense of Duty）以及黑板任务进行决策
- LLM只负责确定"意图"或"目标"，例如：
  - "我要去生产棉线" 或 "我要去收获CultivateChamber_2中的作物"
  - 这种高层决策避免了低层细节的复杂性，使LLM专注于合理的决策逻辑

**第二层：中层规划（由Planner完成）**
- Planner根据高层意图和当前环境状态，进行计划分解
- 生成具体的执行序列，例如：`移动到仓库 → 取棉花 → 移动到工作站 → 制造棉线 → 移动到存储区 → 放置布料`
- 考虑环境的动态变化（其他Agent的位置、物品的位置等），进行实时调整
- 处理资源不足等异常情况，自动发布补货任务

**第三层：低层执行**
- 按照Planner生成的执行序列，依次执行具体的游戏命令（Move、Use、Take、Put等）
- 处理命令的反馈和结果

### 系统的闭环反馈
整个系统形成一个闭环：
1. LLM进行高层决策 → 2. Planner进行计划分解 → 3. 执行具体命令 → 4. 返回执行结果和新的游戏状态 → 5. 回到第1步